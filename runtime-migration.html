<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 23 January 2014 
 | Rendered using Apache Maven Fluido Skin 1.3.1
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="The MyBatis Team" />
    <meta name="Date-Revision-yyyymmdd" content="20140123" />
    <meta http-equiv="Content-Language" content="en" />
    <title>MyBatis Migrations - 
    MyBatis Migrations | Runtime Schema Upgrade</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.3.1.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.3.1.min.js"></script>

    
                  </head>
        <body class="topBarDisabled">
          
        
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>MyBatis Migrations</h2>
                </div>
                      </div>
        <div class="pull-right">                                <a href="../" id="bannerRight" title="MyBatis logo">
                                                                                        <img src="http://mybatis.github.io/images/mybatis-logo.png"  alt="MyBatis logo"/>
                </a>
      </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="publishDate">Last Published: 23 January 2014
                      <span class="divider">|</span>
                   </li>
                  <li id="projectVersion">Version: 3.2.1-SNAPSHOT
                      </li>
                      
                
                    
      
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">Migrations</li>
                              
      <li>
  
                          <a href="index.html" title="Introduction">
          <i class="none"></i>
        Introduction</a>
            </li>
                
      <li>
  
                          <a href="installation.html" title="Installation">
          <i class="none"></i>
        Installation</a>
            </li>
                                                                                                                                                                                                            
      <li>
  
                          <a href="migrate.html" title="The 'migrate' Command">
          <i class="icon-chevron-down"></i>
        The 'migrate' Command</a>
                    <ul class="nav nav-list">
                    
      <li>
  
                          <a href="init.html" title="init">
          <i class="none"></i>
        init</a>
            </li>
                    
      <li>
  
                          <a href="bootstrap.html" title="bootstrap">
          <i class="none"></i>
        bootstrap</a>
            </li>
                    
      <li>
  
                          <a href="new.html" title="new">
          <i class="none"></i>
        new</a>
            </li>
                    
      <li>
  
                          <a href="status.html" title="status">
          <i class="none"></i>
        status</a>
            </li>
                    
      <li>
  
                          <a href="updown.html" title="up, down">
          <i class="none"></i>
        up, down</a>
            </li>
                    
      <li>
  
                          <a href="version.html" title="version">
          <i class="none"></i>
        version</a>
            </li>
                    
      <li>
  
                          <a href="pending.html" title="pending">
          <i class="none"></i>
        pending</a>
            </li>
                    
      <li>
  
                          <a href="script.html" title="script">
          <i class="none"></i>
        script</a>
            </li>
                    
      <li>
  
                          <a href="shortcuts.html" title="Command Shortcuts">
          <i class="none"></i>
        Command Shortcuts</a>
            </li>
              </ul>
        </li>
                
      <li class="active">
  
            <a href="#"><i class="none"></i>Runtime Schema Migration</a>
          </li>
                              <li class="nav-header">Project Documentation</li>
                                                                                                                                                                                                                                                                                                        
      <li>
  
                          <a href="project-info.html" title="Project Information">
          <i class="icon-chevron-right"></i>
        Project Information</a>
                  </li>
                                                                                                                                                                                                                                                      
      <li>
  
                          <a href="project-reports.html" title="Project Reports">
          <i class="icon-chevron-right"></i>
        Project Reports</a>
                  </li>
            </ul>
                
                    
                
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span9" >
                                  
            <!-- Copyright 2010-2011 The myBatis Team

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License. --><!-- version: $Id: script.xml 4134 2011-11-27 21:13:20Z simone.tripodi $ -->

  

    <div class="section">
<h2>Runtime Schema Upgrade<a name="Runtime_Schema_Upgrade"></a></h2>

      
<p>
        Since 3.2.0, MyBatis Migrations supports runtime schema upgrade (a.k.a. in-app migration).
      </p>

      
<p>
        If you distributed your application in binary form (e.g. WAR or JAR) and want to make some changes to the database schema after the initial release, that's where the Runtime Schema Upgrade helps.
      </p>

      
<div class="section">
<h3>Overview<a name="Overview"></a></h3>

        
<p>
          To use Runtime Schema Upgrade, you need to create Migration Scripts.<br />
          Migration scripts can be written as text files (.sql) or java classes that implements <tt>MigrationScript</tt> interface.
        </p>

        
<p>
          Then during the startup process of your application, perform 'Up' operation by executing <tt>UpOperation#operate()</tt> method.<br />
          Assuming that your java migration scripts are in 'mycompany.migration.script' package and you can obtain <tt>java.sql.DataSource</tt> instance, the below is the minimum code to perform 'Up' operation.
        </p>

        
<div class="source">
<pre>new UpOperation().operate(
  new DataSourceConnectionProvider(dataSource),
    new JavaMigrationLoader(&quot;mycompany.migration.script&quot;), null, null);</pre></div>

        
<p>
          As the first migration script should be the one that creates the 'changelog' table, the initial release of your application may contain two or more migration scripts.<br />
          To upgrade the schema in the next version, just add new migration scripts to the package.
        </p>

      </div>

      
<div class="section">
<h3>Migration Script<a name="Migration_Script"></a></h3>

        
<p>
          By default, MyBatis Migration supports two types of Migration Script: simple SQL script file (*.sql) and java migration script.
        </p>

        
<p>
          You have already learned about the simple SQL script file (*.sql) that can be generated by the <tt>migrate new</tt> command in the former sections.
          As it is just a text file, it is easy to write or edit, but a little bit harder to use with Runtime Schema Upgrade because it needs to be accessible in the file system (i.e. JAR or WAR must be extracted on the runtime environment).
        </p>

        
<p>
          A java migration script is a java class that implements <tt>MigrationScript</tt> interface (see below).
          It must be compiled, of course, but it can be placed anywhere in the classpath, so it may be a better choice for Runtime Schema Upgrade in most cases.
        </p>

        
<div class="source">
<pre>
public interface MigrationScript {
  BigDecimal getId();
  String getDescription();
  String getUpScript();
  String getDownScript();
}</pre></div>

        
<p>
          <tt>getId()</tt> method should return a unique ID of the migration script. Newer script must return a larger number.<br />
          <tt>getDescription()</tt> method should return a short description of the script.<br />
          <tt>getUpScript()</tt> method should return the actual SQL statements upgrading the schema.<br />
          <tt>getDownScript()</tt> method should return SQL statements downgrading the schema, but it exists mainly for API consistency and would not be used in Runtime Schema Upgrade.
        </p>

        
<p>
          Here is a typical implementation of the first migration script that creates the 'changelog' table:
        </p>

        
<div class="source">
<pre>
package mycompany.migration.script

import java.math.BigDecimal;
import org.apache.ibatis.migration.MigrationScript;

public class V001_CreateChangelog implements MigrationScript {
  public BigDecimal getId() {
    return BigDecimal.valueOf(1L);
  }

  public String getDescription() {
    return &quot;Create changelog&quot;;
  }

  public String getUpScript() {
    return &quot;CREATE TABLE changelog (&quot;
      + &quot;ID NUMERIC(20,0) NOT NULL,&quot;
      + &quot;APPLIED_AT VARCHAR(25) NOT NULL,&quot;
      + &quot;DESCRIPTION VARCHAR(255) NOT NULL); &quot;

      + &quot;ALTER TABLE changelog &quot;
      + &quot;ADD CONSTRAINT PK_changelog &quot;
      + &quot;PRIMARY KEY (id);&quot;;
  }

  public String getDownScript() {
    return &quot;DROP TABLE changelog;&quot;;
  }
}</pre></div>

      </div>

      
<div class="section">
<h3>UpOperation#operate()<a name="UpOperationoperate"></a></h3>

        
<p>
          As shown in the Overview section, Runtime Schema Upgrade is executed by calling the <tt>operate()</tt> method of an <tt>UpOperation</tt> instance.<br />
          The method takes four parameters.
        </p>

        
<ul>
          
<li><tt>ConnectionProvider</tt>: Required. Explained in the later section.</li>
          
<li><tt>MigrationLoader</tt>: Required. Explained in the later section.</li>
          
<li><tt>DatabaseOperationOption</tt>: Optional. If <tt>null</tt> is passed, the default values are used.</li>
          
<li><tt>PrintStream</tt>: Optional. The result of the Up operation will be output to this stream.</li>
        </ul>

      </div>

      
<div class="section">
<h3>ConnectionProvider<a name="ConnectionProvider"></a></h3>

        
<p>
          <tt>ConnectionProvider</tt> interface has only one method <tt>getConnection()</tt> which returns <tt>java.sql.Connection</tt> used by 'Up' operation.
        </p>

        
<div class="source">
<pre>
public interface ConnectionProvider {
  Connection getConnection() throws SQLException;
}</pre></div>

        
<p>
          There are two built-in implementations: <tt>DataSourceConnectionProvider</tt> and <tt>JdbcConnectionProvider</tt>.
        </p>

        
<p>
          You have already seen the example usage of <tt>DataSourceConnectionProvider</tt> in the Overview section.
          The constructor takes an instance of <tt>java.sql.DataSource</tt> as its only argument.
        </p>

        
<p>
          <tt>JdbcConnectionProvider</tt> takes four constructor arguments: JDBC driver class, JDBC URL, username and password.<br />
          Using <tt>JdbcConnectionProvider</tt>, the example code in the Overview section can be rewritten as follows.
        </p>

        
<div class="source">
<pre>new UpOperation().operate(
  new JdbcConnectionProvider(&quot;org.hsqldb.jdbcDriver&quot;, &quot;jdbc:hsqldb:mem:mydb&quot;, &quot;myname&quot;, &quot;mypassword&quot;),
    new JavaMigrationLoader(&quot;mycompany.migration.script&quot;), null, null);</pre></div>

      </div>

      
<div class="section">
<h3>MigrationLoader<a name="MigrationLoader"></a></h3>

        
<p>
          <tt>MigrationLoader</tt> abstracts where and how to load your migration scripts.<br />
          There are two built-in implementations: <tt>FileMigrationLoader</tt> and <tt>JavaMigrationLoader</tt>.
        </p>

        
<p>
          <tt>FileMigrationLoader</tt> is used to load simple SQL scripts (*.sql).<br />
          Its constructor takes three arguments:
        </p>

        
<div class="source">
<pre>FileMigrationLoader(File scriptsDir, String charset, Properties properties)</pre></div>

        
<ul>
          
<li><tt>scriptsDir</tt> is the only required parameter and it indicates the directory containing the migration scripts. Note that the directory must exist in the file system of the runtime environment.</li>
          
<li><tt>charset</tt> is the character set of the migration scripts.
          If <tt>null</tt> is passed, system's default charset is used.</li>
          
<li><tt>properties</tt> is used for variable substitution when reading the migration scripts (e.g. ${changelog}).</li>
        </ul>

        
<p>
          <tt>JavaMigrationLoader</tt> loads java classes which implement <tt>MigrationScript</tt> interface.<br />
          There are two constructors defined for <tt>JavaMigrationLoader</tt>
        </p>

        
<div class="source">
<pre>JavaMigrationLoader(String... packageNames)

JavaMigrationLoader(ClassLoader classLoader, String... packageNames)</pre></div>

        
<ul>
          
<li><tt>packageNames</tt> is the list of packages that contains migration scripts.
          Note that the migration scripts are ordered by their IDs.</li>
          
<li><tt>classLoader</tt> is used to search the migration scripts and is optional.</li>
        </ul>

      </div>

    </div>

  


                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                              <p >Copyright &copy;                    2010&#x2013;2014
                        <a href="http://www.mybatis.org/">MyBatis.org</a>.
            All rights reserved.      
                    
      </p>
        </div>

        
        
                </div>
    </footer>
        </body>
</html>
